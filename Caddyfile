# Production Caddyfile for Birdmaid
# This file is mounted into the Caddy container

# Frontend domain
# Note: ${DOMAIN} will be substituted by entrypoint script
# DOMAIN should be the full domain (e.g., birdmaid.su or example.com)
${DOMAIN} {
    # Proxy to frontend container (serves static files)
    reverse_proxy front:80 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        # Note: X-Forwarded-For and X-Forwarded-Proto are set automatically by Caddy
    }
    
    # Enable compression
    encode gzip zstd
    
    # Security headers
    header {
        # Disable server tokens (Caddy doesn't expose version by default, but explicit is better)
        -Server
        
        # X-Frame-Options: Allow same-origin embedding (games are embedded in iframes)
        X-Frame-Options "SAMEORIGIN"
        
        # X-Content-Type-Options: Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # X-XSS-Protection: Enable XSS filtering (legacy, but still useful)
        X-XSS-Protection "1; mode=block"
        
        # Referrer-Policy: Control referrer information
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Permissions-Policy: Restrict browser features
        Permissions-Policy "geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=(self),payment=()"
        
        # Content-Security-Policy: Flexible CSP for game iframes
        # Note: Games are embedded in iframes, so we need to allow frame-src from various sources
        # Adjust this based on your S3/CDN domains
        # font-src allows Google Fonts (fonts.googleapis.com for CSS, fonts.gstatic.com for font files)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com https://fonts.googleapis.com; frame-src 'self' *; connect-src 'self' https:;"
    }
    
    # Logging
    log {
        output stdout
        format console
    }
}

# Backend API domain
# Note: ${DOMAIN} will be substituted by entrypoint script
# DOMAIN should be the full domain (e.g., birdmaid.su or example.com)
api.${DOMAIN} {
    # Proxy to backend
    reverse_proxy back:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        # Note: X-Forwarded-For and X-Forwarded-Proto are set automatically by Caddy
    }
    
    # Enable compression for API responses (but not for build files which may already be compressed)
    @not_build_files_compress {
        not path /games/*/build/*
    }
    encode @not_build_files_compress gzip
    
    # Security and CORS headers for build files (games/*/build/*)
    # These files are loaded in iframes and need to load scripts, images, etc.
    @build_files {
        path /games/*/build/*
    }
    header @build_files {
        # Disable server tokens
        -Server
        
        # X-Content-Type-Options: Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # X-XSS-Protection: Enable XSS filtering
        X-XSS-Protection "1; mode=block"
        
        # Referrer-Policy: Control referrer information
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Permissions-Policy: Restrict browser features
        Permissions-Policy "geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=(self),payment=()"
        
        # Content-Security-Policy: Permissive for build files (games need to load scripts, images, etc.)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https:;"
    }
    
    # Matcher for non-build-file requests (API endpoints)
    @not_build_files {
        not path /games/*/build/*
    }
    
    # Security and CORS headers for API endpoints (default, strict CSP)
    # Apply to all requests EXCEPT build files (which have their own CSP)
    header @not_build_files {
        # Disable server tokens
        -Server
        
        # X-Content-Type-Options: Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # X-XSS-Protection: Enable XSS filtering
        X-XSS-Protection "1; mode=block"
        
        # Referrer-Policy: Control referrer information
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Permissions-Policy: Restrict browser features
        Permissions-Policy "geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=(),payment=()"
        
        # Content-Security-Policy: Strict for API (no iframes needed)
        Content-Security-Policy "default-src 'self'; script-src 'none'; style-src 'none'; img-src 'none'; font-src 'none'; frame-src 'none';"
        
        # CORS headers are handled by the backend (NestJS)
        # Backend correctly sets Access-Control-Allow-Origin to specific origin (not "*")
        # when credentials are required, which is required by CORS spec
    }
    
    # Logging
    log {
        output stdout
        format console
    }
}

# Health check endpoint (optional, for monitoring)
:8080 {
    respond /health "OK" 200
    log {
        output stdout
        format console
    }
}
