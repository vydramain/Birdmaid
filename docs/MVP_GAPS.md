# MVP Gaps Analysis

Дата анализа: 2026-01-09
Основа: сравнение консолидированного описания MVP с текущей реализацией

## Критические пробелы (блокируют работу)

### 1. API контракт не задокументирован
**Проблема**: `docs/API.yaml` пустой (только TODO комментарии)
**Влияние**: Нет единого источника истины для API; фронтенд/тесты могут расходиться с бэкендом
**Решение**: Заполнить `docs/API.yaml` OpenAPI спецификацией для всех реализованных endpoints

### 2. Signed build URL не реализован
**Проблема**: ADR-020 требует signed URL для iframe, но код формирует публичный URL
**Код**: `back/src/app.controller.ts:427` - просто конкатенация URL
**Влияние**: Build URL публичный и не защищен; любой может получить прямой доступ
**Решение**: Использовать `GetObjectPresignedUrlCommand` из AWS SDK для генерации временных подписанных URL

### 3. CSP headers не отправляются
**Проблема**: CSP политика определена в коде (`cspPolicy`), но не отправляется как HTTP заголовок
**Код**: `back/src/app.controller.ts:62-63` - только константа
**Влияние**: Браузер не применяет CSP политику; игры могут нарушать безопасность
**Решение**: Добавить middleware/interceptor в NestJS для установки `Content-Security-Policy` заголовка

## Важные пробелы (влияют на UX/функциональность)

### 4. Сортировка в каталоге не реализована
**Проблема**: `GET /games?tag=...&sort=...` упоминается в UX_MAP, но `sort` параметр не обрабатывается
**Код**: `back/src/app.controller.ts:172` - только фильтрация по тегам
**Влияние**: Пользователи не могут сортировать игры (по дате, названию, популярности)
**Решение**: Добавить обработку `sort` параметра в `listGames` endpoint

### 5. GET /tags endpoint отсутствует
**Проблема**: В UX_MAP упоминается `GET /tags` для получения списка всех тегов
**Влияние**: Фронтенд не может показать список доступных тегов для фильтрации
**Решение**: Реализовать endpoint, который возвращает уникальные теги из всех published игр

### 6. PATCH endpoints отсутствуют
**Проблема**: 
- `PATCH /admin/teams/{id}` упоминается в API.yaml, но не реализован
- `PATCH /admin/games/{id}` упоминается в UX_MAP, но не реализован (есть только POST для создания)
**Влияние**: Невозможно редактировать существующие команды/игры (только создание)
**Решение**: Реализовать PATCH endpoints для обновления teams и games

### 7. Frontend: фильтрация по тегам не реализована
**Проблема**: Бэкенд поддерживает `?tag=...`, но на фронтенде нет UI для выбора тегов
**Код**: `front/src/App.tsx:224-325` - CatalogPage не имеет фильтров
**Влияние**: Пользователи не могут фильтровать игры по тегам
**Решение**: Добавить UI для выбора тегов (dropdown/checkboxes) и передавать `tag` параметр в API

### 8. Frontend: сортировка не реализована
**Проблема**: Нет UI для выбора сортировки
**Влияние**: Пользователи не могут сортировать игры
**Решение**: Добавить UI для выбора сортировки (dropdown) и передавать `sort` параметр в API

## Средние пробелы (улучшают качество/безопасность)

### 9. Frontend: нет обработки CSP из ответа API
**Проблема**: Бэкенд возвращает `csp` в ответе `GET /games/{id}`, но фронтенд не использует его
**Код**: `back/src/app.controller.ts:226,249` - возвращает `csp`, но фронтенд игнорирует
**Влияние**: CSP не применяется на клиенте (хотя должен быть в заголовках)
**Решение**: Если CSP должен быть в meta tag, добавить обработку; иначе убрать из ответа (если только в headers)

### 10. Отсутствует валидация формата cover_url
**Проблема**: Нет проверки, что `cover_url` - валидный URL или изображение
**Влияние**: Можно указать невалидный URL или не-изображение
**Решение**: Добавить валидацию URL и опционально проверку MIME типа

### 11. Отсутствует валидация формата repo_url
**Проблема**: Нет проверки, что `repo_url` - валидный URL
**Влияние**: Можно указать невалидный URL
**Решение**: Добавить валидацию URL формата

### 12. Нет обработки ошибок при загрузке сборки в S3
**Проблема**: Если S3 недоступен, ошибка может быть неинформативной
**Код**: `back/src/app.controller.ts:417-424` - нет try/catch вокруг S3 операций
**Влияние**: Плохой UX при ошибках S3
**Решение**: Добавить обработку ошибок S3 с понятными сообщениями

### 13. Нет rate limiting для upload
**Проблема**: Нет защиты от злоупотреблений (множественные загрузки)
**Влияние**: Возможны DoS атаки или злоупотребление ресурсами
**Решение**: Добавить rate limiting для `/admin/games/:id/build` endpoint

### 14. Нет логирования критических операций
**Проблема**: Нет логов для publish/status changes/upload
**Влияние**: Сложно отлаживать и аудировать действия админа
**Решение**: Добавить логирование через NestJS Logger для критических операций

## Низкоприоритетные пробелы (nice to have)

### 15. MinIO bucket публичность
**Статус**: В docker-compose есть `mc anonymous set download`, но стоит проверить
**Решение**: Проверить, что bucket действительно публичный и build_url доступен

### 16. Проверка ZIP содержит index.html
**Статус**: Есть проверка (строка 406), но стоит убедиться, что она работает корректно
**Решение**: Добавить тест для этого случая

### 17. .gitignore полнота
**Статус**: Выглядит нормально, но стоит убедиться, что артефакты не коммитятся
**Решение**: Проверить, что `artifacts/` действительно игнорируется

## Уже реализовано (проверено)

✅ Remark обязателен при published → editing (строки 487-489, 500-502)
✅ Публикация требует cover_url + description_md + build (строки 452-454, 464-466)
✅ Фильтрация по тегам на бэкенде (строки 190-192)
✅ Admin guard на всех /admin/* endpoints
✅ Build size limit enforcement (строки 381-384)
✅ Visibility rules (editing/archived скрыты от публики, строки 212-214, 235-237)

## Рекомендации по приоритетам

### Критично (сделать сразу):
1. API.yaml заполнить
2. Signed build URL
3. CSP headers

### Важно (сделать в ближайшее время):
4. Сортировка в каталоге
5. GET /tags endpoint
6. PATCH endpoints
7. Frontend фильтрация/сортировка

### Средне (можно отложить):
8-14. Валидации, обработка ошибок, логирование, rate limiting

### Низко (когда будет время):
15-17. Проверки и улучшения
